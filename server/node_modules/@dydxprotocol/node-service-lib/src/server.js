/* eslint no-console: 0 */

import bodyParser from 'body-parser';
import cors from 'cors';
import express from 'express';

import Bugsnag from './helpers/bugsnag';
import RequestLogger from './middlewares/request-logger';

export default function (index) {
  const app = express();

  // This needs to be the first middleware
  app.use(Bugsnag.requestHandler);
  const corsOptions = {
    origin: process.env.CORS_ORIGIN,
    optionsSuccessStatus: 200,
  };
  app.use(cors(corsOptions));

  app.get('/health', (req, res) => {
    res.status(200).json({ ok: true });
  });

  app.use((req, res, next) => next());

  app.use(bodyParser.json());

  app.use(RequestLogger);

  if (index) {
    app.use('/v1', index);
  }

  // This needs to be the last non-error middleware
  app.use(Bugsnag.errorHandler);

  app.use((req, res) => {
    res.status(404).json({
      error: 'Not Found',
      errorCode: 404,
    });
  });

  return app;
}
